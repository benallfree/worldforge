!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const e=7;let t=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"),"");const r=(e=>{if(e<0||e>100)throw new Error(`Grid size ${e} out of range`);return e})(20);let s,o,n,a=Object,l=a.getPrototypeOf,c=document,i=(e,t,r,s)=>(e??(setTimeout(r,s),new Set)).add(t),d={get val(){return this.t},set val(e){let t=this,r=t.t;if(e!==r){t.o===r?o=i(o,t,A):e===t.o&&o.delete(t),t.t=e;for(let s of t.l)s(e,r)}},onnew(e){this.l.push(e)}},u=l(d),p=e=>l(e??0)===d,v=e=>p(e)?e.t:e,f=e=>e.map(v),m=e=>e.nodeType?e:new Text(e),h=(e,...t)=>{for(let r of t.flat(1/0))v(r)!=s&&e.appendChild(l(r)===d?b(r,(e=>e)):m(r));return e},g={},w=e=>new Proxy(((t,...r)=>{var o;let[n,...i]=l(r[0]??0)===u?r:[{},...r],p=e?c.createElementNS(e,t):c.createElement(t);for(let[e,c]of a.entries(n)){let r=t=>t?a.getOwnPropertyDescriptor(t,e)??r(l(t)):s,n=t+","+e,i=g[n]??(g[n]=(null==(o=r(l(p)))?void 0:o.set)??0)?t=>p[e]=t:t=>p.setAttribute(e,t);l(c)===d?b(c,(e=>(i(e),p))):l(c)===u?b(...c.deps,((...e)=>(i(c.f(...e)),p))):i(c)}return h(p,...i)}),{get:(e,t)=>e.bind(s,t)}),y=e=>e.i=e.i.filter((e=>{var t;return null==(t=e.u)?void 0:t.isConnected})),A=()=>{let e=[...o];o=s;for(let r of new Set(e.flatMap(y))){let{_:e,u:o}=r,n=r.g(...f(e),o,...(t=e,t.map((e=>p(e)?e.o:e))));n!==o&&(n!=s?o.replaceWith(r.u=m(n)):(o.remove(),r.u=s))}var t;for(let r of e)r.o=r.t},b=(...e)=>{let t=e.pop(),r=t(...f(e));if(r!=s){let o={_:e,u:m(r),g:t};for(let t of e)p(t)&&(n=i(n,t,(()=>(n.forEach(y),n=s)),1e3),t.i.push(o));return o.u}};const E={add:h,tags:w(),tagsNS:w,state:e=>({__proto__:d,t:e,o:e,i:[],l:[]}),bind:b},{button:C,div:x,a:I,p:$,pre:S,br:T,input:k,img:P,sup:O,h1:W,textarea:D}=E.tags,{state:M,bind:N}=E;function _(e){if(!e)throw new Error("Assertion failure")}const L=e=>F("onclick",e),j=e=>F("onmousedown",e),F=(e,t)=>({[e]:function(e){e.target===this&&(e.stopPropagation(),null==t||t(e))}}),R=16,z=e=>{const{name:t,selected:r,onClick:s,extraProps:o}={selected:!1,onClick:()=>{},...e};return C({class:"ToolButton "+(r?"selected":""),...L(s),...o},t)},B=e=>{const{assetEditor:t}=ge,{setSelectedColor:r,selectedColor:s}=t;function o(){r(this.value)}return s.onnew(console.log),N(s,(e=>k({class:"ToolButton",type:"color",style:"border-radius: 8px;",value:e,onchange:o})))};var H=(e=>(e[e.Draw=0]="Draw",e[e.Erase=1]="Erase",e))(H||{});const U={0:"✏️",1:"🧹"},q=e=>{const{tool:t}=e,{assetEditor:r}=ge,{currentTool:s}=r;return N(s,(e=>z({name:U[t],selected:e===t,onClick:()=>{s.val=t}})))},J=e=>x({class:"Tools"},q({tool:H.Draw}),q({tool:H.Erase}),B(),(e=>{const{saveAsset:t,assetEditor:r}=ge,{currentAsset:s}=r;return N(s,(e=>(_(e),z({name:"💾",onClick:()=>t(s.val)}))))})(),(e=>{const{closeAssetEditor:t}=ge;return z({name:"😾",onClick:t})})(),z({name:"👯‍♀️",onClick:()=>{const{assetEditor:e}=ge,{cloneAsset:t}=e;t()}})),G=e=>x({class:"Preview"},"preview"),K=()=>x({class:"Canvas"},J(),V({},X({},(e=>{const{assetEditor:t}=ge,{rgbHexPixels:r,setPixel:s}=t,o=(e,t)=>{if(!(e instanceof PointerEvent||e.buttons))return;const r=Math.floor(t/R);s(t%R,r)};return n=x({class:"PixelEditor"},...r.map(((e,t)=>N(e,(e=>{return x({class:"pixel",style:{deps:[e],f:e=>`background-color: ${e}`},...(r=e=>o(e,t),F("onmousemove",r)),...j((e=>o(e,t)))});var r}))))),n.addEventListener("contextmenu",(function(e){e.preventDefault()})),n;var n})(),(e=>{const{assetEditor:t}=ge,{currentAsset:r,palette:s,setSelectedColor:o}=t;return N(r,s,((e,t)=>(_(e),x({class:"CustomPalette"},...t.map((e=>x({class:"color",style:`background-color: ${e}`,...L((()=>{o(e)}))})))||[]))))})()),X({},G(),G()))),V=(e,...t)=>x({class:"row"},...t),X=(e,...t)=>x({class:"col"},...t),Y="#00000001",Q=()=>t(),Z=e=>{const{sprite:t,id:r,name:s}=e;return{sprite:t,id:r,name:s}},ee="data:null",te=async e=>{const t={id:Q(),sprite:ee,name:"Unknown asset",...e},{id:r,sprite:s,name:o}=t;return{id:r,name:o,sprite:s}};function re(e){const t=e.toString(16);return 1===t.length?"0"+t:t}const se=(e,t=0)=>({red:e[t],green:e[t+1],blue:e[t+2],alpha:e[t+3]}),oe=(e,t,r,s)=>`#${re(e)}${re(t)}${re(r)}${re(s)}`;const ne=e=>{const t=e.getContext("2d");if(!t)throw new Error("ctx required");return t};function ae(e,t,r,s){const o=ne(s);o.clearRect(e,t,1,1);const{alpha:n,red:a,green:l,blue:c}=(e=>({alpha:parseInt(e.slice(7,9),16),red:parseInt(e.slice(1,3),16),green:parseInt(e.slice(3,5),16),blue:parseInt(e.slice(5,7),16)}))(r);if(!isNaN(n)&&!n)return;const i=((e,t,r)=>`rgb(${e}, ${t}, ${r})`)(a,l,c);o.fillStyle=i,o.fillRect(e,t,1,1)}function le(e){const t=ne(e),{width:r,height:s}=e,o=t.getImageData(0,0,r,s).data,n=[];for(let a=0;a<o.length;a+=4){const{red:e,green:t,blue:r,alpha:s}=se(o,a),l=oe(e,t,r,s);n.push(l)}return n}const ce=()=>{const e=M(H.Draw),t=M("#00FF00"),r=M(void 0),s=(()=>{const e=document.createElement("canvas");return e.width=R,e.height=R,ne(e).clearRect(0,0,15,15),e})(),o=M([]),n=le(s).map((e=>M(e))),a={setAsset:e=>{r.val=e;const{sprite:t}=e;(async(e,t)=>{await new Promise((r=>{const s=new Image;s.onload=function(){ne(e).drawImage(s,0,0),r()},s.src=t}))})(s,t).then((()=>{o.val=function(e){var t;return(t=le(e),t.filter(((e,t,r)=>r.indexOf(e)===t))).filter((e=>e!==Y))}(s),le(s).forEach(((e,t)=>n[t].val=e))})).catch(console.error)},cloneAsset:()=>{const e=r.val;_(e);const t=(s=e,{...s,id:Q(),name:`Copy of ${s.name}`});var s;a.setAsset(t)},clearAsset:()=>{r.val=void 0},setSelectedColor:r=>{t.val=r,e.val=H.Draw},setPixel:(a,l)=>{_(r.val);const c=e.val===H.Draw?t.val:Y;ae(a,l,c,s),c===Y||o.val.some((e=>e===c))||(o.val=[...o.val,c]),n[l*R+a].val=c},setTool:t=>{e.val=t},currentTool:e,selectedColor:t,currentAsset:r,rgbHexPixels:n,palette:o,canvas:s};return a};const ie=()=>{const e=t(),r=M(!1),s=M({title:"New Modal"});r.onnew((t=>{setTimeout((()=>{const{event:r}=s.val;if(!t||!r)return;const o=document.getElementById(e);_(o),function(e,t){const r=t.pageX,s=t.pageY,o=e.offsetWidth,n=e.offsetHeight,a=window.innerWidth-o,l=window.innerHeight-n;let c=r,i=s;c>a&&(c=a),i>l&&(i=l),e.style.left=c+"px",e.style.top=i+"px",e.style.transform="none"}(o,r)}),0)}));const o=()=>{r.val=!1};return[()=>N(r,s,((t,r)=>{if(!t)return x();const{title:s,event:n,children:a}=r;return x({class:n?"":"modal-overlay",...L((()=>o()))},x({id:e,class:"Modal"},W(s),x({class:"close",...L(o)},"❌"),...a||[]))})),(e,...t)=>{o(),s.val={...e,children:t},r.val=!0},o,r]};function de(e){let t=function(e){return e?Object.getOwnPropertyNames(e):[]}(e);return Array.isArray(e)&&(t=t.filter((e=>"length"!==e))),t}const ue="__worldcraft__",pe=localStorage.getItem(ue);pe&&localStorage.setItem(`${ue}_${+new Date}`,pe);const ve=()=>{const e=(e=>{if(!e)return null;try{return JSON.parse(e)}catch{}return null})(localStorage.getItem(ue));return{splash:!1,worlds:{},..."object"==typeof e?e:{}}},fe=(e,t)=>{const r=ve();return void 0===r[e]?t:r[e]},me=()=>t(),he=()=>{const e=fe("currentWorldId",void 0);if(!e)return;var t;return t=e,fe("worlds",{})[t]};me(),ce();const ge=(()=>{const e=M(!1),t=M(me()),s=r,o=M("New World"),n={},a=M([]),l={},c=ce();{const r=he();r?(t.val=r.id,o.val=r.name,Object.entries(r.assets).reduce(((e,[t,r])=>e.then((e=>te(r).then((r=>{const s=M(r);return _(e),e[t]=s,e})).catch(console.error))).catch(console.error)),Promise.resolve(n)).then((t=>{if(!t)throw new Error("Expected collection here");a.val=de(t),e.val=!0})).catch(console.error)):e.val=!0}const i=()=>({id:t.val,name:o.val,assets:Object.values(n).reduce(((e,t,r)=>{const s=Z(t.val);return e[s.id]=s,e}),{}),cells:Object.entries(l).reduce(((e,[t,r])=>{const s={assets:r.val.assets.map((e=>e))};return e[t]=s,e}),{})}),[d,u,p,v]=ie(),f=M(void 0);return{createAsset:async()=>await(async()=>({id:Q(),name:"New Asset",sprite:ee}))(),openAssetEditor:async e=>{te(Z(e)).then((e=>{c.setAsset(e),u({title:e.name},x({class:"AssetEditor"},K()))})).catch(console.error)},closeAssetEditor:()=>{c.clearAsset(),p()},saveAsset:e=>(n[e.id]||(n[e.id]=M(e)),n[e.id].val=e),id:t,loaded:e,size:s,name:o,assets:n,assetIds:a,serializeWorld:()=>JSON.stringify(i()),worldAtRest:i,openModal:u,closeModal:p,modal:d,isModalOpen:v,activeAssetId:f,setActiveAssetId:e=>f.val=e,addAssetToTerrainCell:(e,t,r)=>{const s=((e,t)=>`${e}:${t}`)(e,t);l[s]||(l[s]=M({assets:[]}));const o=l[s].val,{assets:n}=o;l[s].val={...o,assets:[...n,{assetId:r}]},(()=>{throw new Error("save the world")})()},cells:l,assetEditor:c}})(),we=e=>Array(e).fill(0);const ye=e=>async function(e){const t=(new TextEncoder).encode(e),r=new CompressionStream("deflate"),s=r.writable.getWriter();s.write(t),s.close();const o=await new Response(r.readable).arrayBuffer(),n=new Uint8Array(o),a=String.fromCharCode.apply(null,n);return encodeURIComponent(btoa(a))}(e).then((e=>`WFDLC*${e}`)),Ae=()=>{const{size:e}=ge;return x({class:"TerrainMap"},x({class:"grid",style:"width: "+(t=50*e,`${t}px`)},...we(e).map(((t,r)=>we(e).map(((e,t)=>(e=>{const{activeAssetId:t,addAssetToTerrainCell:r,isModalOpen:s,openModal:o}=ge,n=M(!1);s.onnew((e=>{e||(n.val=!1)}));const{x:a,y:l}=e;return x(x({class:"cell",...L((e=>{t.val?r(a,l,t.val):(o({title:`Asset Editor ${a}x${l}`,event:e},x("asset editor")),n.val=!0)}))},"cell",N(n,(e=>e?x({class:"active"}):x()))))})({x:r,y:t})))))),(()=>{const{id:e,name:t,serializeWorld:r}=ge,s=D();ye(r()).then((r=>{const o=`https://worldforgegame.web.app?pm=${r}`,n=t.val,a=e.val;s.value=`Hey, check out my WorldForge map!\n\nMap name: ${n}\nWorld ID: ${a}\n\n${o}\n\nNote: If the link doesn't work, just copy this whole message into the WorldForge share tool and click Import.`})).catch(console.error);const o=()=>{s.select(),document.execCommand("copy"),alert("DLC copied to clipboard! Share on messaging apps!")},{openModal:n,closeModal:a}=ge;return x({class:"ShareTool"},C({class:"share",...L((()=>n({title:"Share a World"},x($("Copy your DLC below and share it over text, Discord, WhatsApp, Twitter, or anywhere else you want!"),s,x(C({...L(o)},"📋"))))))},x("⤴️",T(),"share")))})());var t},be=e=>{const{asset:t,active:r,onClick:s}=e;return x({class:"ToolbarSprite "+(r?"active":"")},(e=>{const{asset:t,onclick:r}=e;return N(t,(e=>{const{id:t,sprite:s}=e;return P({class:"sprite",src:s,...L(r)})}))})({asset:t,...L(s)}),x({class:"controls"},C("edit")))},Ee=()=>x((()=>{const{activeAssetId:e,assetIds:t,assets:r,createAsset:s,openAssetEditor:o,setActiveAssetId:n}=ge;return N(t,e,((e,t)=>{const a=e.map((e=>{const s=r[e];return _(s),be({asset:s,active:t===s.val.id,onClick:()=>{n(s.val.id)}})}));return x({class:"Toolbar"},...a,C({...L((()=>{s().then(o).catch(console.error)}))},"+"))}))})(),Ae());E.add(document.getElementById("app"),(()=>{const{loaded:t,modal:r}=ge;return x({class:"App"},N(t,(e=>e?Ee():W("WorldForge"))),x({class:"footer"},I({href:"https://github.com/benallfree/worldforge"},"WorldForge"),` build ${e}. Created with love under the MIT open source license. `),r())})());
