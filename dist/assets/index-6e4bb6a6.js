const app="",build=14,bytes=11268,buildInfo={build:build,bytes:bytes};let nanoid=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"),"");const TILE="tile",LAYER="layer",INTERACTIVE="interactive",CONTAINER="container",CLEARFIX="clearfix",NOSELECT="no-select",PULSING="pulsing",DANGER="danger",SUCCESS="success",mkClass=(...e)=>({class:e.map((e=>Array.isArray(e)?e.join(" "):e)).join(" ")});let e,t,o,l=Object,r=l.getPrototypeOf,f=document,n=(e,t,s,o)=>(e??(setTimeout(s,o),new Set)).add(t),s={get val(){return this.t},set val(e){let s=this,o=s.t;if(e!==o){s.o===o?t=n(t,s,v):e===s.o&&t.delete(s),s.t=e;for(let t of s.l)t(e,o)}},onnew(e){this.l.push(e)}},d=r(s),a$1=e=>r(e??0)===s,i=e=>a$1(e)?e.t:e,u=e=>e.map(i),_=e=>e.nodeType?e:new Text(e),g=(t,...o)=>{for(let a of o.flat(1/0))i(a)!=e&&t.appendChild(r(a)===s?b(a,(e=>e)):_(a));return t},w={},m=t=>new Proxy(((o,...a)=>{var n;let[i,...c]=r(a[0]??0)===d?a:[{},...a],u=t?f.createElementNS(t,o):f.createElement(o);for(let[t,m]of l.entries(i)){let a=s=>s?l.getOwnPropertyDescriptor(s,t)??a(r(s)):e,i=o+","+t,c=w[i]??(w[i]=(null==(n=a(r(u)))?void 0:n.set)??0)?e=>u[t]=e:e=>u.setAttribute(t,e);r(m)===s?b(m,(e=>(c(e),u))):r(m)===d?b(...m.deps,((...e)=>(c(m.f(...e)),u))):c(m)}return g(u,...c)}),{get:(t,s)=>t.bind(e,s)}),p$1=e=>e.i=e.i.filter((e=>{var t;return null==(t=e.u)?void 0:t.isConnected})),v=()=>{let s=[...t];t=e;for(let t of new Set(s.flatMap(p$1))){let{_:s,u:r}=t,a=t.g(...u(s),r,...(o=s,o.map((e=>a$1(e)?e.o:e))));a!==r&&(a!=e?r.replaceWith(t.u=_(a)):(r.remove(),t.u=e))}var o;for(let e of s)e.o=e.t},b=(...t)=>{let s=t.pop(),r=s(...u(t));if(r!=e){let a={_:t,u:_(r),g:s};for(let s of t)a$1(s)&&(o=n(o,s,(()=>(o.forEach(p$1),o=e)),1e3),s.i.push(a));return a.u}};const van={add:g,tags:m(),tagsNS:m,state:e=>({__proto__:s,t:e,o:e,i:[],l:[]}),bind:b},{button:button,div:div,a:a,p:p,pre:pre,br:br,input:input,img:img,sup:sup,h1:h1,h2:h2,textarea:textarea}=van.tags,{state:state,bind:bind}=van;function assert(e){if(!e)throw new Error("Assertion failure")}const objectEntries=e=>Object.entries(e),mkOnClick=(e,t)=>mkOn("onclick",e,t),mkOnMouseMove=(e,t)=>mkOn("onmousemove",e,t),mkOnMouseDown=(e,t)=>mkOn("onmousedown",e,t),mkOn=(e,t,s)=>{const{targetOnly:o}={targetOnly:!1,...s};return{[e]:function(e){o&&e.target!==this||(e.stopPropagation(),null==t||t(e))}}},ToolButton=e=>{const{title:t,selected:s,onClick:o,extraProps:r,unstyled:a}={unstyled:!1,selected:!1,onClick:()=>{},...e},n={...r,...mkClass("ToolButton",INTERACTIVE,s?"selected":"",a?"unstyled":"")};return button({...n,...mkOnClick(o)},t())},Toolbar=e=>{const{floating:t,tools:s,onToolItemClicked:o,activeItemIdx:r}={activeItemIdx:0,floating:!1,tools:[],onToolItemClicked:e=>{a.val=e},...e},a=state(r);return bind(a,(e=>div({...mkClass("Toolbar",CLEARFIX)},div({...mkClass(t?"floating":"")},...s.map(((t,s)=>ToolButton({selected:e===s,onClick:()=>o(s),...t})))))))},DefaultTabManagerProps={tabs:{}},TabManager=e=>{const{tabs:t}={...DefaultTabManagerProps,...e},s=objectEntries(t);assert(s.length>0);const o=state(0);return bind(o,(e=>div({...mkClass("TabManager")},Toolbar({tools:s.map((([t],s)=>({title:()=>t,selected:e===s}))),onToolItemClicked:e=>{o.val=e}}),s[e][1]())))},range=e=>[...Array(e)].map(((e,t)=>t)),Preview=e=>{const{background:t}=e,{assetEditor:s}=gameStore,{dataUrl:o}=s;return div({...mkClass("Preview",CLEARFIX),style:`background-color: ${t}`},...range(9).map((()=>div({...mkClass("preview-cell",TILE)},div({...mkClass("border-overlay",TILE,LAYER)}),img({...mkClass(TILE,LAYER),src:o})))))};var EditorTools=(e=>(e[e.Draw=0]="Draw",e[e.Erase=1]="Erase",e))(EditorTools||{});const ColorTool=e=>{const{assetEditor:t}=gameStore,{setSelectedColor:s,selectedColor:o}=t;function r(){s(this.value)}return bind(o,(e=>input({type:"color",style:"border-radius: 8px;",value:e,onchange:r})))},CustomPalette=e=>{const{assetEditor:t}=gameStore,{currentAsset:s,palette:o,setSelectedColor:r}=t;return bind(s,o,((e,t)=>(assert(e),div({...mkClass("CustomPalette",CLEARFIX)},...t.map((e=>div({...mkClass("color"),style:`background-color: ${e}`,...mkOnClick((()=>{r(e)}))})))||[]))))},SPRITE_SIZE=16,noRightClick=e=>(e.addEventListener("contextmenu",(function(e){e.preventDefault()})),e),PixelEditor=e=>{const{assetEditor:t}=gameStore,{rgbHexPixels:s,setPixel:o}=t,r=(e,t)=>{if(!(e instanceof PointerEvent||e.buttons))return;const s=Math.floor(t/SPRITE_SIZE);o(t%SPRITE_SIZE,s)},a=div({...mkClass("PixelEditor")},...s.map(((e,t)=>div({...mkClass("pixel",INTERACTIVE),style:{deps:[e],f:e=>`background-color: ${e}`},...mkOnMouseMove((e=>r(e,t))),...mkOnMouseDown((e=>r(e,t)))}))));return noRightClick(a)},Canvas=()=>{const{assetEditor:e}=gameStore,{currentTool:t}=e;return bind(t,(e=>div({...mkClass("Canvas")},Toolbar({tools:[{title:()=>"âœï¸",onClick:()=>{t.val=EditorTools.Draw},selected:e===EditorTools.Draw},{title:()=>"ðŸ§¹",onClick:()=>{t.val=EditorTools.Erase},selected:e===EditorTools.Erase},{title:()=>ColorTool(),onClick:()=>{},unstyled:!0,selected:!1}]}),div({...mkClass("grid-container")},div(PixelEditor(),CustomPalette()),div(Preview({background:"black"}),Preview({background:"white"}))))))},getRenderFn=code=>eval(`(${code})`),checkRenderFn=e=>{try{return getRenderFn(e),""}catch(t){return`${t.message}`}},DefaultCodeEditorProps={},CodeEditor=e=>{const{assetEditor:t}=gameStore,{currentAsset:s}=t,o=s.val;assert(o);const{code:r}=o,a=state(checkRenderFn(r));return div({...mkClass("CodeEditor")},p("Write your custom code here."),bind(a,(e=>e?p({class:"danger"},`Syntax error: ${e}`):div())),textarea({oninput:function(){s.val={...o,code:this.value},a.val=checkRenderFn(this.value)}},r))},DefaultBedrockEditorProps={},BedrockEditor=(e,...t)=>{const{assetEditor:s}=gameStore,{currentAsset:o}=s;return bind(o,(e=>(assert(e),div({...mkClass("BedrockEditor")},button({...mkClass(e.isBedrock?"selected":""),...mkOnClick((()=>{const e=o.val;assert(e),o.val={...e,isBedrock:!e.isBedrock}}))},"Bedrock")))))},DefaultDescriptionEditorProps={},DescriptionEditor=(e,...t)=>{const{assetEditor:s}=gameStore,{currentAsset:o}=s,r=o.val;return div({...mkClass("DescriptionEditor")},bind(r,(e=>{assert(e);const{description:t}=e;return textarea({onchange:function(){o.val={...e,description:this.value}}},t)})))},DefaultTitleEditorProps={},TitleEditor=(e,...t)=>{const{assetEditor:s}=gameStore,{currentAsset:o}=s;return bind(o,(e=>{assert(e);const{name:t}=e;return div({...mkClass("TitleEditor")},input({type:"text",value:t,onchange:function(){const e=o.val;assert(e),o.val={...e,name:this.value}}}))}))},DefaultMetaProps={},Meta=e=>div({...mkClass("Meta")},p("Title"),TitleEditor(),p("Description"),DescriptionEditor(),p("Bedrock"),BedrockEditor()),toAssetId=e=>e,newAssetId=()=>nanoid(),isAssetAtRest=e=>"id"in e&&"code"in e&&"sprite"in e,EMPTY_SPRITE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",createNewAssetState=()=>({id:newAssetId(),name:"New Asset",description:"",code:"",isBedrock:!1,sprite:EMPTY_SPRITE}),inMemoryToAtRestAsset=e=>{const{sprite:t,id:s,name:o,description:r,code:a,isBedrock:n}=e;return{sprite:t,id:s,name:o,description:r,code:a,isBedrock:n}},atRestToInMemoryAsset=async e=>{const t={id:newAssetId(),sprite:EMPTY_SPRITE,name:"Unknown asset",description:"",code:"",isBedrock:!1,...e},{id:s,sprite:o,name:r,description:a,code:n,isBedrock:i}=t;return{id:s,name:r,description:a,code:n,sprite:o,isBedrock:i}},cloneAsset=e=>({...e,id:newAssetId(),name:`Copy of ${e.name}`}),WF_QS="wfdlc";async function compress(e){const t=(new TextEncoder).encode(e),s=new CompressionStream("deflate"),o=s.writable.getWriter();o.write(t),o.close();const r=await new Response(s.readable).arrayBuffer(),a=new Uint8Array(r),n=String.fromCharCode.apply(null,a);return encodeURIComponent(btoa(n))}function decompress(e){const t=atob(decodeURIComponent(e)),s=new Uint8Array(t.length);for(let a=0;a<t.length;a++)s[a]=t.charCodeAt(a);const o=new DecompressionStream("deflate"),r=o.writable.getWriter();return r.write(s),r.close(),new Response(o.readable).arrayBuffer().then((function(e){return(new TextDecoder).decode(e)}))}const WF_PACK_HEADER="WFDLC*",pack=e=>compress(e).then((e=>`${WF_PACK_HEADER}${e}`)),unpack=async e=>{const[,t]=e.match(/WFDLC\*(.+)/)||[];if(t)return decompress(t)},mkShareUrl=e=>pack(e).then((e=>`${document.location.origin}?${WF_QS}=${e}`)),Copyable=e=>{const{content:t,success:s,instructions:o}={success:"Copied to clipboard!",instructions:"Copy (CTRL+C / CMD+C) or use the copy button below.",...e},r=state(!1),a=textarea({readonly:!0},t);return div(p(o),a,div(button({...mkOnClick((()=>{a.select(),document.execCommand("copy"),r.val=!0}))},"ðŸ“‹"),bind(r,(e=>e?div({...mkClass(SUCCESS)},s):div()))))};function base10ToHex(e){const t=e.toString(16);return 1===t.length?"0"+t:t}const parseRgbHex=e=>({alpha:parseInt(e.slice(7,9),16),red:parseInt(e.slice(1,3),16),green:parseInt(e.slice(3,5),16),blue:parseInt(e.slice(5,7),16)}),base10RgbToCssRgb=(e,t,s)=>`rgb(${e}, ${t}, ${s})`,pixelDataToParsedRgba=(e,t=0)=>({red:e[t],green:e[t+1],blue:e[t+2],alpha:e[t+3]}),base10RgbaToHex=(e,t,s,o)=>`#${base10ToHex(e)}${base10ToHex(t)}${base10ToHex(s)}${base10ToHex(o)}`,rgbaToRgb=e=>e.slice(0,7),rgbToRgba=(e,t)=>`${e}${base10ToHex(t)}`,scaleDataURL=async(e,t)=>new Promise(((s,o)=>{const r=new Image;r.onload=()=>{const e=document.createElement("canvas");e.width=r.width*t,e.height=r.height*t;const o=ctx(e);o.imageSmoothingEnabled=!1,o.drawImage(r,0,0,e.width,e.height);const a=e.toDataURL();s(a)},r.onerror=()=>{o(new Error("Failed to load image."))},r.src=e})),mkTilingProof=async(e,t)=>new Promise(((s,o)=>{const r=document.createElement("canvas"),a=r.getContext("2d");if(!a)return void o("Canvas context is not supported");const n=new Image;n.onload=()=>{const e=n.width*t,o=n.height*t;r.width=3*e,r.height=2*o,a.fillStyle="white",a.fillRect(0,0,e,2*o),a.fillStyle="black",a.fillRect(e,0,2*e,2*o),a.fillStyle="gray",a.fillRect(2*e,0,3*e,2*o);const i=Math.ceil(e/8),l=Math.ceil(e/i),c=Math.ceil(2*o/i);a.fillStyle="darkgray";for(let t=0;t<c;t++)for(let s=0;s<l;s++)(s+t)%2==0&&a.fillRect(2*e+s*i,t*i,i,i);a.imageSmoothingEnabled=!1,a.drawImage(n,0,0,n.width,n.height,0,0,e,o),a.drawImage(n,0,0,n.width,n.height,e,0,e,o),a.drawImage(n,0,0,n.width,n.height,2*e,0,e,o);const d=Math.ceil(e/3),u=Math.ceil(e/d),m=Math.ceil(o/d);for(let t=0;t<3*m;t++)for(let e=0;e<3*u;e++)a.drawImage(n,0,0,n.width,n.height,e*d,o+t*d,d,d);const p=r.toDataURL();s(p)},n.onerror=e=>{o(`Error loading image: ${e}`)},n.src=e})),ctx=e=>{const t=e.getContext("2d");if(!t)throw new Error("ctx required");return t},initializeCanvas=e=>{e.width=SPRITE_SIZE,e.height=SPRITE_SIZE,ctx(e).clearRect(0,0,SPRITE_SIZE-1,SPRITE_SIZE-1)},createCanvas=()=>{const e=document.createElement("canvas");return initializeCanvas(e),e},blitSpriteToCanvas=async(e,t)=>{await new Promise((s=>{const o=new Image;o.onload=function(){ctx(e).drawImage(o,0,0),s()},o.src=t}))},clearPixel=(e,t,s)=>{ctx(s).clearRect(e,t,1,1)};function drawPixel(e,t,s,o){const r=ctx(o);r.clearRect(e,t,1,1);const{red:a,green:n,blue:i}=parseRgbHex(s),l=base10RgbToCssRgb(a,n,i);r.fillStyle=l,r.fillRect(e,t,1,1)}function getCanvasPixelData(e){const t=ctx(e),{width:s,height:o}=e,r=t.getImageData(0,0,s,o).data,a=[];for(let n=0;n<r.length;n+=4){const{red:e,green:t,blue:s,alpha:o}=pixelDataToParsedRgba(r,n),i=base10RgbaToHex(e,t,s,o);a.push(i)}return a}const mkIssueTemplate=(e,t)=>{const{name:s,description:o,code:r}=e;return`\n# ${s}.\n\n[[THUMBNAIL]]\n\n${o||"No description provided."}\n\n[Click to import this asset](${t}) or copy/paste the Import section below to import manually.\n\n## Tiling Proof\n\n[[TILING]]\n\n## Code\n\n${r?`\`\`\`js\n${r}\n\`\`\``:"This asset contains no code."}\n\n## Import\n\n\`\`\`json\n${JSON.stringify(e,null,2)}\n\`\`\`\n\n`},DefaultShareToolProps={},ShareTool$1=e=>{const t=state(EMPTY_SPRITE),s=state(EMPTY_SPRITE),o=state(""),{assetEditor:r}=gameStore,{currentAsset:n}=r,i=n.val;assert(i);const{sprite:l}=i;return Promise.all([mkTilingProof(l,10).then((e=>{s.val=e})),scaleDataURL(l,3).then((e=>{t.val=e})),mkShareUrl(JSON.stringify(inMemoryToAtRestAsset(i))).then((e=>{o.val=e}))]).catch(console.error),bind(i,s,t,o,((e,t,s,o)=>div({...mkClass("ShareTool")},TabManager({tabs:{Link:()=>div(p("Share your asset with your friends. Copy and paste "),Copyable({content:`Check out my WorldForge asset: ${e.name}!\n\n${o}`})),github:()=>div(p("The best way to share your assets is through the official github repo."),h1("Step 1 - Open a new github issue"),p(a({href:"https://github.com/benallfree/awesome-worldforge/issues/new",class:"button",target:"_blank"},"go to github")),h1("Step 2: Copy and paste this for the title"),Copyable({content:`[Asset Submission] ${e.name}`}),h1("Step 3: Copy and paste this into the issue body"),Copyable({content:mkIssueTemplate(inMemoryToAtRestAsset(e),o)}),h1("Step 4: Copy and paste this into the issue body where the [[THUMBNAIL]] placeholder is."),img({src:s}),h1("Step 5: Copy and paste this into the issue body where the [[TILING]] placeholder is."),img({src:t}))}}))))},CancelTool=e=>{const{closeAssetEditor:t}=gameStore;return{title:()=>"ðŸ˜¾",onClick:t,selected:!1}},CloneTool=e=>({title:()=>"ðŸ‘¯â€â™€ï¸",onClick:()=>{const{assetEditor:e}=gameStore,{cloneAsset:t}=e;t()},selected:!1}),DefaultDeleteToolProps={},DeleteTool=e=>{const{closeModal:t,deleteAsset:s,assetEditor:o}=gameStore,{currentAsset:r}=o,a=r.val;assert(a);const{id:n}=a;return{extraProps:{class:"danger"},title:()=>"ðŸ’€",onClick:()=>{assert(n),t().then((()=>{s(n)}))},selected:!1}},SaveTool=()=>{const{saveAsset:e,assetEditor:t}=gameStore,{currentAsset:s}=t;return{title:()=>"ðŸ’¾",onClick:()=>{const t=s.val;assert(t),e(t)},selected:!1}},AssetEditor=e=>div({...mkClass("AssetEditor")},Toolbar({floating:!0,tools:[SaveTool(),CancelTool(),CloneTool(),DeleteTool({})]}),TabManager({tabs:{Canvas:()=>Canvas(),Meta:()=>Meta(),Code:()=>CodeEditor(),Share:()=>ShareTool$1()}})),RGB_TRANSPARENT="#00000000",RGB_GREEN="#00FF00";function uniq(e){return Array.from(new Set(e))}function createPaletteFromCanvas(e){return uniq(getCanvasPixelData(e)).filter((e=>e!==RGB_TRANSPARENT)).map(rgbaToRgb)}const createAssetEditorStore=()=>{const e=state(EditorTools.Draw),t=state(RGB_GREEN),s=state(void 0),o=createCanvas(),r=state([]),a=state(o.toDataURL()),n=getCanvasPixelData(o).map((e=>state(e))),i={setAsset:async e=>{s.val=e;const{sprite:t}=e;initializeCanvas(o),r.val=[],n.forEach((e=>e.val=RGB_TRANSPARENT)),a.val=EMPTY_SPRITE,await blitSpriteToCanvas(o,t),r.val=createPaletteFromCanvas(o),getCanvasPixelData(o).forEach(((e,t)=>n[t].val=e)),a.val=o.toDataURL()},cloneAsset:()=>{const e=s.val;assert(e);const t=cloneAsset(e);i.setAsset(t)},clearAsset:()=>{s.val=void 0},setSelectedColor:s=>{t.val=s,e.val=EditorTools.Draw},setPixel:(i,l)=>{const c=s.val;assert(c),e.val===EditorTools.Erase?(clearPixel(i,l,o),n[l*SPRITE_SIZE+i].val=RGB_TRANSPARENT):(drawPixel(i,l,t.val,o),n[l*SPRITE_SIZE+i].val=rgbToRgba(t.val,255)),r.val=createPaletteFromCanvas(o),a.val=o.toDataURL(),s.val={...c,sprite:a.val}},setTool:t=>{e.val=t},currentTool:e,selectedColor:t,currentAsset:s,rgbHexPixels:n,palette:r,canvas:o,dataUrl:a};return i},nextTick=()=>new Promise((e=>setTimeout(e))),newModalId=()=>nanoid();function positionDivAroundMouse(e,t){const s=t.pageX,o=t.pageY,r=e.offsetWidth,a=e.offsetHeight,n=window.innerWidth-r,i=window.innerHeight-a;let l=s,c=o;l>n&&(l=n),c>i&&(c=i),e.style.left=l+"px",e.style.top=c+"px",e.style.transform="none"}const DEFAULT_MODAL={title:()=>"New Modal",body:()=>div("Empty modal body")},Modal=()=>{const e=newModalId(),t=state(!1),s=state(DEFAULT_MODAL);t.onnew((t=>{setTimeout((()=>{const{event:o}=s.val;if(!t||!o)return;const r=document.getElementById(e);assert(r),positionDivAroundMouse(r,o)}),0)}));const o=async()=>{var e,o;t.val=!1,await nextTick(),null==(o=(e=s.val).onClose)||o.call(e),s.val=DEFAULT_MODAL,await nextTick()};return[()=>bind(t,s,((t,s)=>{if(!t)return div();const{title:r,event:a,body:n}=s;return div({...mkClass(a?"":["modal-overlay",LAYER]),...mkOnClick((()=>o()),{targetOnly:!0})},div({id:e,...mkClass("Modal")},div({...mkClass("title",LAYER)},r()),div({...mkClass("close",INTERACTIVE),...mkOnClick(o)},"âŒ"),div({...mkClass("body")},n())))})),async e=>{await o(),s.val={...e},t.val=!0,await nextTick()},o,t]},mkXOffset=e=>e,mkYOffset=e=>e,MAX_GRID_SIZE=100,mkGridSize=e=>{if(e<0||e>MAX_GRID_SIZE)throw new Error(`Grid size ${e} out of range`);return e},xyToSlug=(e,t)=>`${e}:${t}`,TILE_SIZE=50,DEFAULT_GRID_SIZE=mkGridSize(20),toCellId=e=>e,atRestToInMemoryCell=async e=>{const t={assets:[],...e},{assets:s}=t;return{assets:s}};function keys(e){let t=keysOfNonArray(e);return Array.isArray(e)&&(t=t.filter((e=>"length"!==e))),t}function keysOfNonArray(e){return e?Object.getOwnPropertyNames(e):[]}const clone=e=>JSON.parse(JSON.stringify(e)),ROOT_KEY="__worldforge__",safeParse=e=>{if(!e)return null;try{return JSON.parse(e)}catch{}return null},_getRoot=()=>{const e=safeParse(localStorage.getItem(ROOT_KEY));return{splash:!1,worlds:{},..."object"==typeof e?e:{}}},_setRoot=e=>localStorage.setItem(ROOT_KEY,JSON.stringify(e)),getKeyOrDefault=(e,t)=>{const s=_getRoot();return void 0===s[e]?t:s[e]},setKey=(e,t)=>{const s=_getRoot();s[e]=t,_setRoot(s)},loadCurrentWorldId=()=>getKeyOrDefault("currentWorldId",void 0),saveCurrentWorldId=e=>setKey("currentWorldId",e),loadWorld=e=>getKeyOrDefault("worlds",{})[e],saveWorld=e=>{const t=getKeyOrDefault("worlds",{});t[e.id]=e,setKey("worlds",t)},newWorldId=()=>nanoid(),mkPointSlug=e=>e,loadCurrentWorld=()=>{const e=loadCurrentWorldId();if(!e)return;return loadWorld(e)},mkWorldName=e=>e;newWorldId(),mkWorldName("New World");const atRestCell=e=>({assets:e.assets.map((e=>e))}),createGameStore=()=>{const e=state(!1),t=state(!1),s=state(newWorldId()),o=DEFAULT_GRID_SIZE,r=state(mkWorldName("New World")),a={},n=state([]),i={},l=createAssetEditorStore();range(o).forEach((e=>{range(o).forEach((t=>{const s=xyToSlug(e,t);i[s]=state({assets:[]})}))}));const c=()=>{saveWorld(d()),saveCurrentWorldId(s.val)};{const t=loadCurrentWorld();t?(s.val=t.id,r.val=t.name,Promise.all([Object.entries(t.assets).reduce((async(e,[t,s])=>{try{const r=await e;try{const e=await atRestToInMemoryAsset(s),o=state(e);return assert(r),r[toAssetId(t)]=o,r}catch(o){return}}catch(o){return}}),Promise.resolve(a)).then((e=>{assert(e),n.val=keys(e)})).catch(console.error),Object.entries(t.cells).reduce((async(e,[t,s])=>{try{const r=await e;try{const e=await atRestToInMemoryCell(s),o=state(e);return assert(r),r[toCellId(t)]=o,r}catch(o){return}}catch(o){}}),Promise.resolve(i)).catch(console.error)]).then((()=>{e.val=!0}))):e.val=!0}const d=()=>({id:s.val,name:r.val,assets:Object.values(a).reduce(((e,t,s)=>{const o=inMemoryToAtRestAsset(t.val);return e[o.id]=o,e}),{}),cells:Object.entries(i).reduce(((e,[t,s])=>{const o=atRestCell(s.val);return e[mkPointSlug(t)]=o,e}),{})}),[u,m,p,v]=Modal(),g=state(void 0),h={createAsset:async()=>createNewAssetState(),deleteAsset:async e=>{delete a[e],Object.entries(i).map((([t,s])=>{s.val={...s,assets:s.val.assets.filter((t=>t.assetId!==e))}})),n.val=keys(a),c()},openAssetEditor:async e=>{const t=await atRestToInMemoryAsset(inMemoryToAtRestAsset(e));await l.setAsset(t);const{currentAsset:s}=l;m({title:()=>"Asset Editor",body:()=>AssetEditor(),onClose:()=>{const e=s.val;assert(e),h.saveAsset(e)}})},closeAssetEditor:()=>{p().then((()=>{l.clearAsset()}))},saveAsset:e=>{a[e.id]||(a[e.id]=state(e)),a[e.id].val=e,n.val=uniq([...n.val,e.id]),c(),h.closeAssetEditor()},worldId:s,loaded:e,size:o,name:r,assets:a,assetIds:n,serializeWorld:()=>JSON.stringify(d()),worldAtRest:d,openModal:m,closeModal:p,modal:u,isModalOpen:v,activeAssetId:g,setActiveAssetId:e=>g.val=e,addAssetToTerrainCell:(e,t,s)=>{const o=xyToSlug(e,t);i[o]||(i[o]=state({assets:[]}));const r=i[o].val,n=[...r.assets,{assetId:s}].reverse(),l=[n.find((e=>a[e.assetId].val.isBedrock)),n.find((e=>!a[e.assetId].val.isBedrock))].filter((e=>!!e));i[o].val={...r,assets:l},c()},cells:i,assetEditor:l,imported:t};return h},gameStore=createGameStore(),Sprite=e=>{const{asset:t,onclick:s}={onclick:()=>{},...e};return bind(t,(e=>{const{id:t,sprite:o}=e;return img({...mkClass("Sprite",TILE),src:o,...mkOnClick(s)})}))},AssetBarItem=e=>{const{asset:t,active:s,onClick:o}=e,{openAssetEditor:r}=gameStore,{name:a}=t;return div({...mkClass("AssetBarItem",CONTAINER)},s?div({...mkClass("active",LAYER,PULSING)}):div(),div({...mkClass(CONTAINER)},div({...mkClass("title")},a),Sprite({asset:t,...mkOnClick(o)}),div({...mkClass("controls")},button({...mkOnClick((()=>{r(t).catch(console.error)}))},"edit"))))},AssetBar=()=>{const{activeAssetId:e,assetIds:t,assets:s,createAsset:o,openAssetEditor:r,setActiveAssetId:a,closeModal:n}=gameStore;return bind(t,e,((e,t)=>{const i=e.map((e=>{const o=s[e];return assert(o),bind(o,(e=>{const{id:s}=e;return AssetBarItem({asset:e,active:t===s,onClick:()=>{t===s?a(void 0):(n(),a(s))}})}))}));return div({...mkClass("AssetBar")},...i,button({...mkOnClick((()=>{o().then(r).catch(console.error)}))},"+"))}))},getQueryStringVariable=e=>new URLSearchParams(window.location.search).get(e),DefaultImportToolProps={onFinished:()=>assert(!1)},ImportTool=e=>{const{onFinished:t}={...DefaultImportToolProps,...e},{openModal:s,saveAsset:o,assets:r,assetIds:a}=gameStore,n=()=>{setTimeout(t)},i=getQueryStringVariable(WF_QS);return i?(async()=>{try{const e=await unpack(i);if(!e)throw new Error("Import payload could not be unpacked.");const t=JSON.parse(e);if(!isAssetAtRest(t))throw new Error("Import object not recognized.");const a=await atRestToInMemoryAsset(t),l=!!r[a.id];s({title:()=>`Import Asset: ${a.name}`,body:()=>div(l?h2("Import and overwrite?"):div(),Sprite({asset:a}),div(button({...mkClass(l?DANGER:""),...mkOnClick((()=>{o(a),n()}))},"Import")))}),n()}catch(e){s({title:()=>"Import error",body:()=>p(`${e}`),onClose:n})}})():n(),h1("Importing...")},px=e=>`${e}px`,ShareTool=()=>{const{worldId:e,name:t,serializeWorld:s}=gameStore,o=state("");mkShareUrl(s()).then((s=>{const r=t.val,a=e.val;o.val=`Hey, check out my WorldForge map!\n\nMap name: ${r}\nWorld ID: ${a}\n\n${s}\n\nNote: If the link doesn't work, just copy this whole message into the WorldForge share tool and click Import.`})).catch(console.error);const{openModal:r}=gameStore;return button({class:"ShareToolButton",...mkOnClick((()=>r({title:()=>"Share a World",body:()=>div({class:"ShareTool"},bind(o,(e=>Copyable({content:e,success:"DLC copied to clipboard! Share on messaging apps!",instructions:"Copy your DLC below and share it over text, Discord, WhatsApp, Twitter, or anywhere else you want!"}))))})))},div("â¤´ï¸",br(),"share"))},TerrainCell=e=>{const{activeAssetId:t,addAssetToTerrainCell:s,openModal:o,cells:r,assets:a}=gameStore,n=state(!1),{x:i,y:l}=e,c=xyToSlug(i,l),d=e=>{("mousedown"===e.type||e.buttons)&&(t.val?s(i,l,t.val):(t.val=void 0,o({title:()=>`Asset Editor ${i}x${l}`,event:e,onClose:()=>{n.val=!1},body:()=>div("asset editor")}),n.val=!0))};return div({...mkClass("TerrainCell",TILE,INTERACTIVE,CONTAINER),...mkOnMouseDown(d),...mkOnMouseMove(d)},div({...mkClass(LAYER,"border-hint")}),bind(r[c],(e=>e?div({...mkClass(LAYER,"content-container")},...e.assets.map((e=>{const t=a[e.assetId];return bind(t,(e=>img({src:e.sprite,...mkClass(LAYER)})))}))):div())),bind(n,(e=>e?div({...mkClass("active",LAYER,PULSING)}):div())))},TerrainMap=()=>{const{size:e}=gameStore;return div({...mkClass("TerrainMap",CLEARFIX)},div({...mkClass("grid",NOSELECT,CLEARFIX),style:`width: ${px(TILE_SIZE*e)}`},...range(e).map(((t,s)=>range(e).map(((e,t)=>TerrainCell({x:mkXOffset(s),y:mkYOffset(t)})))))),ShareTool())},Game=()=>{const{imported:e}=gameStore;return div(bind(e,(t=>t?div(AssetBar(),TerrainMap()):ImportTool({onFinished:()=>e.val=!0}))))},App=()=>{const{loaded:e,modal:t}=gameStore;return div({...mkClass("App",CLEARFIX)},bind(e,(e=>e?Game():h1("WorldForge"))),div({...mkClass("footer")},a({href:"https://github.com/benallfree/worldforge"},"WorldForge"),` build ${buildInfo.build}. Created with love under the MIT open source license. `),t())};van.add(document.getElementById("app"),App());
