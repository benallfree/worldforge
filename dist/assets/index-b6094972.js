const e=10;let t,s,n,o=(e=21)=>crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+=(t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_"),""),r=Object,a=r.getPrototypeOf,l=document,c=(e,t,s,n)=>(e??(setTimeout(s,n),new Set)).add(t),i={get val(){return this._val},set val(e){let t=this,n=t._val;if(e!==n){t.oldVal===n?s=c(s,t,y):e===t.oldVal&&s.delete(t),t._val=e;for(let s of t.listeners)s(e,n)}},onnew(e){this.listeners.push(e)}},d=a(i),u=e=>a(e??0)===i,p=e=>u(e)?e._val:e,f=e=>e.map(p),v=e=>e.nodeType?e:new Text(e),g=(e,...s)=>{for(let n of s.flat(1/0))p(n)!=t&&e.appendChild(a(n)===i?w(n,(e=>e)):v(n));return e},m={},_=e=>new Proxy(((s,...n)=>{var o;let[c,...u]=a(n[0]??0)===d?n:[{},...n],p=e?l.createElementNS(e,s):l.createElement(s);for(let[e,l]of r.entries(c)){let n=s=>s?r.getOwnPropertyDescriptor(s,e)??n(a(s)):t,c=s+","+e,u=m[c]??(m[c]=(null==(o=n(a(p)))?void 0:o.set)??0)?t=>p[e]=t:t=>p.setAttribute(e,t);a(l)===i?w(l,(e=>(u(e),p))):a(l)===d?w(...l.deps,((...e)=>(u(l.f(...e)),p))):u(l)}return g(p,...u)}),{get:(e,s)=>e.bind(t,s)}),h=e=>e.bindings=e.bindings.filter((e=>{var t;return null==(t=e.dom)?void 0:t.isConnected})),y=()=>{let e=[...s];s=t;for(let s of new Set(e.flatMap(h))){let{_deps:e,dom:o}=s,r=s.func(...f(e),o,...(n=e,n.map((e=>u(e)?e.oldVal:e))));r!==o&&(r!=t?o.replaceWith(s.dom=v(r)):(o.remove(),s.dom=t))}var n;for(let t of e)t.oldVal=t._val},w=(...e)=>{let s=e.pop(),o=s(...f(e));if(o!=t){let r={_deps:e,dom:v(o),func:s};for(let s of e)u(s)&&(n=c(n,s,(()=>(n.forEach(h),n=t)),1e3),s.bindings.push(r));return r.dom}};const b={add:g,tags:_(),tagsNS:_,state:e=>({__proto__:i,_val:e,oldVal:e,bindings:[],listeners:[]}),bind:w};let A;const E=(e,t)=>{if(!e){if(!A)throw new Error(t);return A.push(t),!1}return!0},C=Object.getPrototypeOf,I=C(b.state()),x=e=>(E(!(e instanceof Node),"DOM Node is not valid value for state"),E(C(e??0)!==I,"State couldn't have value to other state"),e),O=e=>"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"bigint"==typeof e,$=e=>e instanceof Node||O(e),S=e=>{E($(e)||null==e||C(e??0)===I&&(O(e.val)||null===e.val||void 0===e.val),"Only DOM Node, string, number, boolean, bigint, null, undefined and state of string, number, boolean, bigint, null or undefined are valid child of a DOM Node"),E(!(null==e?void 0:e.isConnected),"You can't add a DOM Node that is already connected to document")},k=e=>new Proxy(b.tagsNS(e),{get:(e,t)=>{const s=e[t];return(...e)=>{const[t,...n]=C(e[0]??0)===Object.prototype?e:[{},...e],o={};for(const[s,r]of Object.entries(t)){const e=s.startsWith("on")?e=>(E("function"==typeof e,`Invalid property value for ${s}: Only functions are allowed for on... handler`),e):e=>(E(O(e),`Invalid property value for ${s}: Only string, number, boolean, bigint are valid prop value types`),e);C(r??0)===I?o[s]={deps:[r],f:t=>e(t)}:C(r??0)===Object.prototype?(E(Array.isArray(r.deps),"For state-derived properties, you want specify an Array in `deps` field"),E("function"==typeof r.f,"For state-derived properties, you want specify the generation function in `f` field"),o[s]={deps:r.deps,f:(...t)=>e(r.f(...t))}):o[s]=e(r)}for(const s of n.flat(1/0))S(s);return s(o,...n)}}}),D={add:(e,...t)=>{E(e instanceof Node,"1st argument of `add` function must be a DOM Node object");for(const s of t.flat(1/0))S(s);return b.add(e,...t)},tags:k(),tagsNS:e=>(E("string"==typeof e,"Must provide a string for parameter `ns` in `tagsNS`"),k(e)),state:e=>new Proxy(b.state(Object.freeze(x(e))),{set:(e,t,s)=>("val"===t&&Object.freeze(x(s)),Reflect.set(e,t,s)),get:(e,t)=>"onnew"===t?t=>{E("function"==typeof t,"You should pass-in functions to register `onnew` handlers"),e.onnew(t)}:Reflect.get(e,t)}),bind:(...e)=>{let t=e.pop();return E(e.length>0,"`bind` must be called with 1 or more states as dependencies"),E("function"==typeof t,"The last argument of `bind` must be the generation function"),b.bind(...e,((...s)=>{const n=t(...s);if(!E(null==n||$(n),"The result of `bind` generation function must be DOM node, primitive, null or undefined"))return null;if(s.length>e.length){const t=s[e.length];if(!E(t instanceof Node&&t.isConnected,"The previous result of the `bind` generation function must be a DOM node connected to document"))return null;n!==t&&n instanceof Node&&E(!n.isConnected,"If the result of `bind` generation fucntion is not the same as previous one, it shouldn't be already connected to document")}return n}))},startCapturingErrors:()=>A=[],stopCapturingErrors:()=>A=null,get capturedErrors(){return A}},{button:M,div:N,a:P,p:T,pre:j,br:W,input:R,img:z,sup:U,h1:F,textarea:B}=D.tags,{state:L,bind:H}=D,V="_grid-container_xygly_1";function J(e){if(!e)throw new Error("Assertion failure")}const q=(e,t)=>Q("onclick",e,t),Y=(e,t)=>Q("onmousemove",e,t),G=(e,t)=>Q("onmousedown",e,t),Q=(e,t,s)=>{const{targetOnly:n}={targetOnly:!1,...s};return{[e]:function(e){n&&e.target!==this||(e.stopPropagation(),null==t||t(e))}}},X="_CustomPalette_davw5_1",K="_color_davw5_4",Z=16,ee="_PixelEditor_1q5f4_1",te="_pixel_1q5f4_10",se=e=>[...Array(e)].map(((e,t)=>t)),ne="_Preview_1m0zu_1",oe="_preview-cell_1m0zu_6",re="_border-overlay_1m0zu_12",ae=e=>{const{background:t}=e,{assetEditor:s}=Ge,{dataUrl:n}=s;return N({class:ne,style:`background-color: ${t}`},...se(9).map((()=>N({class:oe},N({class:re}),z({src:n})))))},le="_ToolButton_15dof_1",ce="_selected_15dof_10",ie=e=>{const{name:t,selected:s,onClick:n,extraProps:o}={selected:!1,onClick:()=>{},...e},r={...o,class:`${le} ${s?ce:""} ${null==o?void 0:o.class}`};return M({...r,...q(n)},t)},de=e=>{const{assetEditor:t}=Ge,{setSelectedColor:s,selectedColor:n}=t;return n.onnew(console.log),R({class:le,type:"color",style:"border-radius: 8px;",value:n,onchange:function(){s(this.value)}})};var ue=(e=>(e[e.Draw=0]="Draw",e[e.Erase=1]="Erase",e))(ue||{});const pe={0:"✏️",1:"🧹"},fe=e=>{const{tool:t}=e,{assetEditor:s}=Ge,{currentTool:n}=s;return H(n,(e=>ie({name:pe[t],selected:e===t,onClick:()=>{n.val=t}})))},ve="_Tools_cd4rf_1",ge=e=>N({class:ve},fe({tool:ue.Draw}),fe({tool:ue.Erase}),de(),(e=>{const{saveAsset:t,assetEditor:s}=Ge,{currentAsset:n}=s;return ie({name:"💾",onClick:()=>{const e=n.val;return J(e),t(e)}})})(),(e=>{const{closeAssetEditor:t}=Ge;return ie({name:"😾",onClick:t})})(),ie({name:"👯‍♀️",onClick:()=>{const{assetEditor:e}=Ge,{cloneAsset:t}=e;t()}}),((e,...t)=>{const{closeModal:s,deleteAsset:n,assetEditor:o}=Ge,{currentAsset:r}=o,a=r.val;J(a);const{id:l}=a;return ie({extraProps:{class:"danger"},name:"💀",onClick:()=>{J(l),s().then((()=>{n(l)}))}})})()),me=()=>N({class:"Canvas"},ge(),N({class:V},N((e=>{const{assetEditor:t}=Ge,{rgbHexPixels:s,setPixel:n}=t,o=(e,t)=>{if(!(e instanceof PointerEvent||e.buttons))return;const s=Math.floor(t/Z);n(t%Z,s)};return r=N({class:ee},...s.map(((e,t)=>N({class:te,style:{deps:[e],f:e=>`background-color: ${e}`},...Y((e=>o(e,t))),...G((e=>o(e,t)))})))),r.addEventListener("contextmenu",(function(e){e.preventDefault()})),r;var r})(),(e=>{const{assetEditor:t}=Ge,{currentAsset:s,palette:n,setSelectedColor:o}=t;return H(s,n,((e,t)=>(J(e),N({class:X},...t.map((e=>N({class:K,style:`background-color: ${e}`,...q((()=>{o(e)}))})))||[]))))})()),N(ae({background:"black"}),ae({background:"white"})))),_e="#00000000",he=()=>o(),ye="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",we=e=>{const{sprite:t,id:s,name:n}=e;return{sprite:t,id:s,name:n}},be=async e=>{const t={id:he(),sprite:ye,name:"Unknown asset",...e},{id:s,sprite:n,name:o}=t;return{id:s,name:o,sprite:n}};function Ae(e){const t=e.toString(16);return 1===t.length?"0"+t:t}const Ee=(e,t=0)=>({red:e[t],green:e[t+1],blue:e[t+2],alpha:e[t+3]}),Ce=(e,t,s,n)=>`#${Ae(e)}${Ae(t)}${Ae(s)}${Ae(n)}`,Ie=e=>e.slice(0,7);function xe(e,t){const s=new Set;return e.filter((e=>{const n=t(e),o=!s.has(n);return s.add(n),o}))}function Oe(e){return Array.from(new Set(e))}const $e=e=>{const t=e.getContext("2d");if(!t)throw new Error("ctx required");return t},Se=e=>{e.width=Z,e.height=Z,$e(e).clearRect(0,0,15,15)};function ke(e,t,s,n){const o=$e(n);o.clearRect(e,t,1,1);const{red:r,green:a,blue:l}=(e=>({alpha:parseInt(e.slice(7,9),16),red:parseInt(e.slice(1,3),16),green:parseInt(e.slice(3,5),16),blue:parseInt(e.slice(5,7),16)}))(s),c=((e,t,s)=>`rgb(${e}, ${t}, ${s})`)(r,a,l);o.fillStyle=c,o.fillRect(e,t,1,1)}function De(e){const t=$e(e),{width:s,height:n}=e,o=t.getImageData(0,0,s,n).data,r=[];for(let a=0;a<o.length;a+=4){const{red:e,green:t,blue:s,alpha:n}=Ee(o,a),l=Ce(e,t,s,n);r.push(l)}return r}function Me(e){return Oe(De(e)).filter((e=>e!==_e)).map(Ie)}const Ne=()=>{const e=L(ue.Draw),t=L("#00FF00"),s=L(void 0),n=(()=>{const e=document.createElement("canvas");return Se(e),e})(),o=L([]),r=L(n.toDataURL()),a=De(n).map((e=>L(e))),l={setAsset:async e=>{s.val=e;const{sprite:t}=e;Se(n),o.val=[],a.forEach((e=>e.val=_e)),r.val=ye,await(async(e,t)=>{await new Promise((s=>{const n=new Image;n.onload=function(){$e(e).drawImage(n,0,0),s()},n.src=t}))})(n,t),o.val=Me(n),De(n).forEach(((e,t)=>a[t].val=e)),r.val=n.toDataURL()},cloneAsset:()=>{const e=s.val;J(e);const t=(n=e,{...n,id:he(),name:`Copy of ${n.name}`});var n;l.setAsset(t)},clearAsset:()=>{s.val=void 0},setSelectedColor:s=>{t.val=s,e.val=ue.Draw},setPixel:(l,c)=>{const i=s.val;J(i),e.val===ue.Erase?(((e,t,s)=>{$e(s).clearRect(e,t,1,1)})(l,c,n),a[c*Z+l].val=_e):(ke(l,c,t.val,n),a[c*Z+l].val=`${t.val}${Ae(255)}`),o.val=Me(n),r.val=n.toDataURL(),s.val={...i,sprite:r.val}},setTool:t=>{e.val=t},currentTool:e,selectedColor:t,currentAsset:s,rgbHexPixels:a,palette:o,canvas:n,dataUrl:r};return l},Pe=()=>new Promise((e=>setTimeout(e))),Te="_modal-overlay_1svl7_1",je="_Modal_1svl7_10",We="_close_1svl7_23";const Re=()=>{const e=o(),t=L(!1),s=L({title:()=>"New Modal",body:()=>N("Empty modal body")});t.onnew((t=>{setTimeout((()=>{const{event:n}=s.val;if(!t||!n)return;const o=document.getElementById(e);J(o),function(e,t){const s=t.pageX,n=t.pageY,o=e.offsetWidth,r=e.offsetHeight,a=window.innerWidth-o,l=window.innerHeight-r;let c=s,i=n;c>a&&(c=a),i>l&&(i=l),e.style.left=c+"px",e.style.top=i+"px",e.style.transform="none"}(o,n)}),0)}));const n=async()=>{var e,n;t.val=!1,await Pe(),null==(n=(e=s.val).onClose)||n.call(e),await Pe()};return[()=>H(t,s,((t,s)=>{if(!t)return N();const{title:o,event:r,body:a}=s;return N({class:r?"":Te,...q((()=>n()),{targetOnly:!0})},N({id:e,class:je},F(o()),N({class:We,...q(n)},"❌"),a()))})),async e=>{await n(),s.val={...e},t.val=!0,await Pe()},n,t]},ze=(e,t)=>`${e}:${t}`,Ue=(e=>{if(e<0||e>100)throw new Error(`Grid size ${e} out of range`);return e})(20);function Fe(e){let t=function(e){return e?Object.getOwnPropertyNames(e):[]}(e);return Array.isArray(e)&&(t=t.filter((e=>"length"!==e))),t}const Be="__worldforge__",Le=()=>{const e=(e=>{if(!e)return null;try{return JSON.parse(e)}catch{}return null})(localStorage.getItem(Be));return{splash:!1,worlds:{},..."object"==typeof e?e:{}}},He=(e,t)=>{const s=Le();return void 0===s[e]?t:s[e]},Ve=(e,t)=>{const s=Le();s[e]=t,(e=>{localStorage.setItem(Be,JSON.stringify(e))})(s)},Je=e=>He("worlds",{})[e],qe=()=>o(),Ye=()=>{const e=He("currentWorldId",void 0);if(!e)return;return Je(e)};qe();const Ge=(()=>{const e=L(!1),t=L(qe()),s=Ue,n=L("New World"),o={},r=L([]),a={},l=Ne();se(s).forEach((e=>{se(s).forEach((t=>{const s=ze(e,t);a[s]=L({assets:[]})}))}));const c=()=>{var e;(e=>{const t=Je(e);t&&localStorage.setItem(`${Be}_${e}_backup_${+new Date}`,JSON.stringify(t))})(t.val),(e=>{const t=He("worlds",{});t[e.id]=e,Ve("worlds",t)})(i()),e=t.val,Ve("currentWorldId",e)};{const s=Ye();s?(t.val=s.id,n.val=s.name,Promise.all([Object.entries(s.assets).reduce((async(e,[t,s])=>{try{const o=await e;try{const e=await be(s),n=L(e);return J(o),o[t]=n,o}catch(n){return}}catch(n){return}}),Promise.resolve(o)).then((e=>{J(e),r.val=Fe(e)})).catch(console.error),Object.entries(s.cells).reduce((async(e,[t,s])=>{try{const o=await e;try{const e=await(async e=>{const t={assets:[],...e},{assets:s}=t;return{assets:s}})(s),n=L(e);return J(o),o[t]=n,o}catch(n){return}}catch(n){}}),Promise.resolve(a)).catch(console.error)]).then((()=>{e.val=!0}))):e.val=!0}const i=()=>({id:t.val,name:n.val,assets:Object.values(o).reduce(((e,t,s)=>{const n=we(t.val);return e[n.id]=n,e}),{}),cells:Object.entries(a).reduce(((e,[t,s])=>{const n={assets:s.val.assets.map((e=>e))};return e[t]=n,e}),{})}),[d,u,p,f]=Re(),v=L(void 0),g={createAsset:async()=>({id:he(),name:"New Asset",sprite:ye}),deleteAsset:async e=>{delete o[e],Object.entries(a).map((([t,s])=>{s.val={...s,assets:s.val.assets.filter((t=>t.assetId!==e))}})),r.val=Fe(o),c()},openAssetEditor:async e=>{const t=await be(we(e));await l.setAsset(t);const{currentAsset:s}=l;u({title:()=>H(s,(e=>{J(e);const{name:t}=e;return R({type:"text",value:t,onchange:function(){const e=s.val;J(e),s.val={...e,name:this.value}}})})),body:()=>N({class:"AssetEditor"},me())})},closeAssetEditor:()=>{p().then((()=>{l.clearAsset()}))},saveAsset:e=>{o[e.id]||(o[e.id]=L(e)),o[e.id].val=e,r.val=Oe([...r.val,e.id]),c(),g.closeAssetEditor()},worldId:t,loaded:e,size:s,name:n,assets:o,assetIds:r,serializeWorld:()=>JSON.stringify(i()),worldAtRest:i,openModal:u,closeModal:p,modal:d,isModalOpen:f,activeAssetId:v,setActiveAssetId:e=>v.val=e,addAssetToTerrainCell:(e,t,s)=>{const n=ze(e,t);a[n]||(a[n]=L({assets:[]}));const o=a[n].val,{assets:r}=o;a[n].val={...o,assets:xe([...r,{assetId:s}],(e=>e.assetId))},c()},cells:a,assetEditor:l};return g})(),Qe="_App_1b8s4_1",Xe="_footer_1b8s4_5";const Ke=e=>async function(e){const t=(new TextEncoder).encode(e),s=new CompressionStream("deflate"),n=s.writable.getWriter();n.write(t),n.close();const o=await new Response(s.readable).arrayBuffer(),r=new Uint8Array(o),a=String.fromCharCode.apply(null,r);return encodeURIComponent(btoa(a))}(e).then((e=>`WFDLC*${e}`)),Ze="_share_ty5fe_1",et="_Modal_ty5fe_13",tt="_cell_1goxv_12",st="_border-hint_1goxv_20",nt="_content-container_1goxv_29",ot="_active_1goxv_43",rt="_TerrainMap_1e9xu_1",at="_grid_1e9xu_4",lt=()=>{const{size:e}=Ge;return N({class:rt},N({class:at,style:"width: "+(t=50*e,`${t}px`)},...se(e).map(((t,s)=>se(e).map(((e,t)=>(e=>{const{activeAssetId:t,addAssetToTerrainCell:s,openModal:n,cells:o,assets:r}=Ge,a=L(!1),{x:l,y:c}=e,i=ze(l,c),d=e=>{("mousedown"===e.type||e.buttons)&&(t.val?s(l,c,t.val):(t.val=void 0,n({title:()=>`Asset Editor ${l}x${c}`,event:e,onClose:()=>{a.val=!1},body:()=>N("asset editor")}),a.val=!0))};return N({class:tt,...G(d),...Y(d)},N({class:st}),H(o[i],(e=>e?N({class:nt},...e.assets.map((e=>{const t=r[e.assetId];return H(t,(e=>z({src:e.sprite})))}))):N())),H(a,(e=>e?N({class:ot}):N())))})({x:s,y:t})))))),(()=>{const{worldId:e,name:t,serializeWorld:s}=Ge,n=B();Ke(s()).then((s=>{const o=`https://worldforgegame.web.app?pm=${s}`,r=t.val,a=e.val;n.value=`Hey, check out my WorldForge map!\n\nMap name: ${r}\nWorld ID: ${a}\n\n${o}\n\nNote: If the link doesn't work, just copy this whole message into the WorldForge share tool and click Import.`})).catch(console.error);const o=()=>{n.select(),document.execCommand("copy"),alert("DLC copied to clipboard! Share on messaging apps!")},{openModal:r,closeModal:a}=Ge;return M({class:Ze,...q((()=>r({title:()=>"Share a World",body:()=>N({class:et},T("Copy your DLC below and share it over text, Discord, WhatsApp, Twitter, or anywhere else you want!"),n,N(M({...q(o)},"📋")))})))},N("⤴️",W(),"share"))})());var t},ct="_Toolbar_1b57j_1",it="_sprite_1dw3j_1",dt="_ToolbarSprite_a30si_12",ut="_title_a30si_19",pt="_controls_a30si_26",ft="_active_a30si_29",vt=e=>{const{asset:t,active:s,onClick:n}=e,{openAssetEditor:o}=Ge;return N({class:`${dt} ${s?ft:""}`},N({class:ut},t.val.name),(e=>{const{asset:t,onclick:s}={onclick:()=>{},...e};return H(t,(e=>{const{id:t,sprite:n}=e;return z({class:it,src:n,...q(s)})}))})({asset:t,...q(n)}),N({class:pt},M({...q((()=>{o(t.val).catch(console.error)}))},"edit")))},gt=()=>N((()=>{const{activeAssetId:e,assetIds:t,assets:s,createAsset:n,openAssetEditor:o,setActiveAssetId:r,closeModal:a}=Ge;return H(t,e,((e,t)=>{const l=e.map((e=>{const n=s[e];return J(n),vt({asset:n,active:t===n.val.id,onClick:()=>{t===n.val.id?r(void 0):(a(),r(n.val.id))}})}));return N({class:ct},...l,M({...q((()=>{n().then(o).catch(console.error)}))},"+"))}))})(),lt());D.add(document.getElementById("app"),(()=>{const{loaded:t,modal:s}=Ge;return N({class:Qe},H(t,(e=>e?gt():F("WorldForge"))),N({class:Xe},P({href:"https://github.com/benallfree/worldforge"},"WorldForge"),` build ${e}. Created with love under the MIT open source license. `),s())})());
